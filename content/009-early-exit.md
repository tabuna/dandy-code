# Ранний выход

Когда рассказываешь историю и постоянно перебиваешь себя новыми деталями, слушатель теряется, забывает с чего всё
началось и ему становится всё труднее следить за ходом мысли. В итоге рассказ превращается в запутанную смесь, которая
теряет смысл.

В программировании аналогичная ситуация возникает, когда в функции слишком глубоко вкладываются условия и циклы. Это
снижает читаемость и усложняет понимание логики.

В прошлой главе мы говорили о важности отдавать результат как можно быстрее. Одним из препятствий для этого является
глубокая вложенность кода. Часто мы мысленно строим блок-схему:

> "Если x равно y, тогда выполнить действие, если y равно z, выполнить другое действие" — и так далее.

Пример глубокой вложенности:

```php
if($condition) {                 // уровень 1
    foreach($users as $user) {   // уровень 2
        if($user->isActive()) {  // уровень 3
            // Обработка
        }
    }
}
```

Каждый новый уровень вложенности усложняет чтение — не линейно, а экспоненциально. 
На третьем уровне вложенности уже приходится держать в голове весь предыдущий контекст. 
Это утомляет и увеличивает когнитивную нагрузку.

Стоит стремиться минимизировать глубину вложенности и предпочитать располагать основные сценарии выполнения функции без
вложенных условий.

```php
// Плохо ❌
if ($condition) {
    // много кода
} else {
    throw new Exception('Условие не выполнено');
}
```

лучше написать так:

```php
if (! $condition) {
    throw new Exception('Условие не выполнено');
}

// много кода
```

Это называется **ранним выходом (early return)**. Мы сразу обрабатываем граничные случаи, а затем плавно движемся по основному сценарию — без вложенности и лишних условий.

Такой подход упрощает чтение и понимание кода, делает его более структурированным и лёгким для поддержки.
Ранний выход актуален не только для исключений, но и для возвращений значений в методах, например:

```php
// Плохо ❌
public function hasAssign(User $user): bool
{
    if ($condition) {
        return // ... много кода;
    }
   
    return false;
}
```

Основной сценарий спрятан внутри условия. Лучше развернуть его наружу:

```php
// Хорошо ✅
public function hasAssign(User $user): bool
{
    if (! $condition) {
        return false;
    }

    return // ... много кода
}
```

В хорошем варианте мы сначала отсекаем негативные случаи, а затем идём по основному сценарию, который расположен в
основной части функции. Это делает код чище и проще для понимания.

Ранний выход полезен не только для условий, но и для циклов:

```php
// Плохо ❌
foreach ($orders as $order) {
    if ($order->isPaid()) {
        foreach ($order->items as $item) {
            if ($item->isInStock()) {
                // обработка
            }
        }
    }
}
```

Можно переписать, используя `continue` для раннего выхода из итерации:

```php
// Хорошо ✅
foreach ($orders as $order) {
    if (! $order->isPaid()) {
        continue;
    }

    foreach ($order->items as $item) {
        if (! $item->isInStock()) {
            continue;
        }

        // обработка
    }
}
```

### Избегайте использования `else`

Отдельного упоминания требует оператор `else`. Сам по себе он не является злом,
но часто его использование указывает на неудачную структуру кода и отличным решением будет минимизировать его использованиие, заменяя его 
ранним выходом. Тогда вместо громоздких условных блоков будут простые и прямолинейные конструкции.

Рассмотрим пример метода, который проверяет, имеет ли пользователь доступ:

```php
// Плохо ❌
public function hasAccess(User $user): bool {
    if (!$user->isBanned()) {
        if ($user->isAdmin()) {
            // Доступ разрешён: админ.
            return true;
        } else {
            if ($user->isGranted(GRANT::EDIT)) {
                // Доступ разрешён: может редактировать.
                return true;
            } else {
                // Доступ запрещён: нет нужных прав.
                return false;
            }

            return false;
        }
    } else {
        // Доступ запрещён: пользователь заблокирован.
        return false;
    }
}
```

Вариант без `else` — чище и проще:

```php
// Хорошо ✅
public function hasAccess(User $user): bool
{
    if ($user->isBanned()) {
        // Пользователь заблокирован
        return false;
    }
    
    if ($user->isAdmin()) {
        // Пользователь является администратором
        return true;
    }
    
    // Пользователь имеет разрешение на редактирование
    return $user->isGranted(GRANT::EDIT);
}
```

Хороший код, как хороший рассказ, не уводит читателя в сторону.
Ранний выход — один из самых эффективных приёмов. 
Применяйте его — и ваши функции станут яснее, проще и приятнее для чтения.
